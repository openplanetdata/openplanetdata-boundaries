name: Planet Coastline

on:
  workflow_dispatch:
  schedule:
    - cron: '0 14 * * *'  # Daily at 2pm UTC

jobs:
  planet-coastline:
    runs-on: self-hosted
    timeout-minutes: 120

    outputs:
      tag: ${{ steps.date.outputs.tag }}

    steps:
      - name: Show runner architecture
        run: echo "arch = ${{ runner.arch }}"

      - name: Set date tag
        id: date
        uses: openplanetdata/actions/set-date-tag@main

      - name: Install system dependencies
        shell: bash
        run: |
          need_install() { ! command -v "$1" &>/dev/null; }
          pkgs=()

          # Check for required tools
          need_install cmake && pkgs+=(cmake)
          need_install g++ && pkgs+=(gcc-c++)
          need_install ogr2ogr && pkgs+=(gdal)
          need_install git && pkgs+=(git)

          if [ ${#pkgs[@]} -gt 0 ]; then
            sudo dnf -y install "${pkgs[@]}"
          fi

          # Install runtime and development libraries needed for osmcoastline
          sudo dnf -y install libosmium-devel geos-devel gdal-devel sqlite-devel zlib-devel bzip2-devel boost-devel

      - name: Get osmcoastline version
        id: osmcoastline_version
        run: |
          # Get the latest commit hash from the repository
          COMMIT=$(git ls-remote https://github.com/osmcode/osmcoastline.git HEAD | cut -f1)
          echo "commit=$COMMIT" >> "$GITHUB_OUTPUT"

      - name: Cache osmcoastline binary
        uses: actions/cache@v4
        id: osmcoastline-cache
        with:
          key: ${{ runner.os }}-osmcoastline-${{ steps.osmcoastline_version.outputs.commit }}
          path: |
            ~/.local/bin/osmcoastline
            ~/.local/bin/osmcoastline_filter
            ~/.local/bin/osmcoastline_segments
            ~/.local/bin/osmcoastline_ways

      - name: Build osmcoastline
        if: steps.osmcoastline-cache.outputs.cache-hit != 'true'
        run: |
          echo "Building osmcoastline from source..."
          cd /tmp
          git clone https://github.com/osmcode/osmcoastline.git
          cd osmcoastline
          mkdir build
          cd build
          cmake -DCMAKE_INSTALL_PREFIX=$HOME/.local ..
          make -j$(nproc)
          make install

      - name: Add osmcoastline to PATH
        run: |
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          # Verify installation
          export PATH="$HOME/.local/bin:$PATH"
          osmcoastline --version

      - name: Download latest published PBF
        uses: openplanetdata/actions/download@main
        with:
          remote_path: osm/planet/pbf/planet-latest.osm.pbf

      - name: Rename downloaded PBF
        run: mv planet-latest.osm.pbf "planet-${{ steps.date.outputs.tag }}.osm.pbf"

      - name: Generate coastline GeoPackage
        run: |
          set -euo pipefail
          TAG="${{ steps.date.outputs.tag }}"
          PBF="planet-${TAG}.osm.pbf"
          GPKG="planet-${TAG}.coastline.gpkg"
          LOG="planet-${TAG}.coastline.osmcoastline.log"

          echo "Starting coastline extraction at $(date -u +%Y-%m-%d_%H:%M:%S)"
          {
            time osmcoastline "$PBF" -o "$GPKG" -g GPKG -p both -v -f -e
          } 2>&1 | tee "$LOG"
          OSMCOASTLINE_STATUS=${PIPESTATUS[0]}

          ls -alh

          if REPORT_TEXT=$(python3 .github/scripts/osmcoastline-report.py "$LOG"); then
            echo ""
            echo "===== osmcoastline report ====="
            printf '%s\n' "$REPORT_TEXT"
            if [ -n "${GITHUB_STEP_SUMMARY:-}" ]; then
              {
                echo "### osmcoastline report"
                echo '```'
                printf '%s\n' "$REPORT_TEXT"
                echo '```'
              } >> "$GITHUB_STEP_SUMMARY"
            fi
          else
            echo "âš  Failed to parse osmcoastline log. Raw log retained at $LOG" >&2
          fi

          if [ "$OSMCOASTLINE_STATUS" -ne 0 ]; then
            echo "osmcoastline exited with status $OSMCOASTLINE_STATUS" >&2

            if [ "$OSMCOASTLINE_STATUS" -eq 1 ] || [ "$OSMCOASTLINE_STATUS" -eq 2 ]; then
              echo "ERRORS: osmcoastline returned $OSMCOASTLINE_STATUS. Collecting diagnostics..."
              echo "ERRORS: Listing generated files matching planet-${TAG}*"
              ls -lh planet-"$TAG"* || true

              if [ -f "$GPKG" ]; then
                echo "ERRORS: Inspecting $GPKG for osmcoastline error details"
                echo "ERRORS: Layer summary via ogrinfo -so:"
                if OGRINFO_OUTPUT=$(ogrinfo "$GPKG" -so 2>&1); then
                  printf '%s\n' "$OGRINFO_OUTPUT" | sed 's/^/  /'
                else
                  echo "ERRORS: ogrinfo -so failed; captured output:"
                  printf '%s\n' "$OGRINFO_OUTPUT" | sed 's/^/  /'
                fi

                if command -v sqlite3 >/dev/null 2>&1; then
                  echo "ERRORS: GeoPackage tables (sqlite_master):"
                  sqlite3 "$GPKG" "SELECT name FROM sqlite_master WHERE type='table' ORDER BY name;" | sed 's/^/  /' || echo "ERRORS: Failed to enumerate tables."

                  if sqlite3 "$GPKG" "SELECT 1 FROM sqlite_master WHERE type='table' AND name='osmcoastline_errors';" | grep -q 1; then
                    echo "ERRORS: $(sqlite3 "$GPKG" "SELECT COUNT(*) FROM osmcoastline_errors;") total error features recorded"
                    sqlite3 "$GPKG" "SELECT fid, reason FROM osmcoastline_errors LIMIT 10;" || echo "ERRORS: Failed to read rows from osmcoastline_errors."
                  else
                    echo "ERRORS: No osmcoastline_errors table found in $GPKG."
                  fi

                  if sqlite3 "$GPKG" "SELECT 1 FROM sqlite_master WHERE type='table' AND name='osmcoastline_warnings';" | grep -q 1; then
                    echo "WARNINGS: $(sqlite3 "$GPKG" "SELECT COUNT(*) FROM osmcoastline_warnings;") total warning features recorded"
                    sqlite3 "$GPKG" "SELECT fid, reason FROM osmcoastline_warnings LIMIT 10;" || echo "WARNINGS: Failed to read rows from osmcoastline_warnings."
                  else
                    echo "WARNINGS: No osmcoastline_warnings table found in $GPKG."
                  fi
                else
                  echo "ERRORS: sqlite3 not available on PATH; skipping GeoPackage inspection."
                fi

              else
                echo "ERRORS: Expected GeoPackage $GPKG was not produced."
              fi
            fi

            exit "$OSMCOASTLINE_STATUS"
          fi

          echo "Coastline extraction finished at $(date -u +%Y-%m-%d_%H:%M:%S)"

      - name: Convert GeoPackage to GeoJSON
        run: |
          TAG="${{ steps.date.outputs.tag }}"
          GPKG="planet-${TAG}.coastline.gpkg"
          GEOJSON="planet-${TAG}.coastline.geojson"

          SQL="SELECT 'land' AS feature_class, a.* FROM land_polygons AS a UNION ALL SELECT 'water' AS feature_class, b.* FROM water_polygons AS b"

          export OGR_GEOJSON_MAX_OBJ_SIZE="${OGR_GEOJSON_MAX_OBJ_SIZE:-0}"

          echo "Starting GeoJSON export at $(date -u +%Y-%m-%d_%H:%M:%S)"
          time ogr2ogr -f GeoJSON "$GEOJSON" "$GPKG" -dialect SQLite -sql "$SQL" -nln planet_coastline -lco RFC7946=YES -lco COORDINATE_PRECISION=6
          echo "GeoJSON export finished at $(date -u +%Y-%m-%d_%H:%M:%S)"

      - name: Convert GeoPackage to GeoParquet
        run: |
          TAG="${{ steps.date.outputs.tag }}"
          GPKG="planet-${TAG}.coastline.gpkg"
          PARQUET="planet-${TAG}.coastline.parquet"

          SQL="SELECT 'land' AS feature_class, a.* FROM land_polygons AS a UNION ALL SELECT 'water' AS feature_class, b.* FROM water_polygons AS b"

          export OGR_GEOJSON_MAX_OBJ_SIZE="${OGR_GEOJSON_MAX_OBJ_SIZE:-0}"

          echo "Starting GeoParquet export at $(date -u +%Y-%m-%d_%H:%M:%S)"
          time ogr2ogr -f Parquet "$PARQUET" "$GPKG" -dialect SQLite -sql "$SQL" -nln planet_coastline -lco COMPRESSION=ZSTD
          echo "GeoParquet export finished at $(date -u +%Y-%m-%d_%H:%M:%S)"

      - name: Create GeoPackage metadata
        uses: openplanetdata/actions/create-metadata@main
        with:
          file: planet-${{ steps.date.outputs.tag }}.coastline.gpkg
          remote_filename: planet-latest.coastline.gpkg
          remote_path: /boundaries/coastline/geopackage
          remote_version: 1
          tags: |
            coastline
            geopackage
            openstreetmap
            private

      - name: Upload GeoPackage to R2
        uses: openplanetdata/actions/upload@main
        env:
          RCLONE_CONFIG_DATA: ${{ secrets.RCLONE_CONFIG_DATA }}
        with:
          file: planet-${{ steps.date.outputs.tag }}.coastline.gpkg
          remote_filename: planet-latest.coastline.gpkg
          remote_path: /boundaries/coastline/geopackage
          remote_version: 1

      - name: Create GeoJSON metadata
        uses: openplanetdata/actions/create-metadata@main
        with:
          file: planet-${{ steps.date.outputs.tag }}.coastline.geojson
          remote_filename: planet-latest.coastline.geojson
          remote_path: /boundaries/coastline/geojson
          remote_version: 1
          tags: |
            coastline
            geojson
            openstreetmap
            private

      - name: Upload GeoJSON to R2
        uses: openplanetdata/actions/upload@main
        env:
          RCLONE_CONFIG_DATA: ${{ secrets.RCLONE_CONFIG_DATA }}
        with:
          file: planet-${{ steps.date.outputs.tag }}.coastline.geojson
          remote_filename: planet-latest.coastline.geojson
          remote_path: /boundaries/coastline/geojson
          remote_version: 1

      - name: Create GeoParquet metadata
        uses: openplanetdata/actions/create-metadata@main
        with:
          file: planet-${{ steps.date.outputs.tag }}.coastline.parquet
          remote_filename: planet-latest.coastline.parquet
          remote_path: /boundaries/coastline/geoparquet
          remote_version: 1
          tags: |
            coastline
            geoparquet
            openstreetmap
            private

      - name: Upload GeoParquet to R2
        uses: openplanetdata/actions/upload@main
        env:
          RCLONE_CONFIG_DATA: ${{ secrets.RCLONE_CONFIG_DATA }}
        with:
          file: planet-${{ steps.date.outputs.tag }}.coastline.parquet
          remote_filename: planet-latest.coastline.parquet
          remote_path: /boundaries/coastline/geoparquet
          remote_version: 1

      - name: Cleanup downloaded files
        if: always()
        uses: openplanetdata/actions/cleanup-downloads@main

      - name: Cleanup generated files
        if: always()
        env:
          TAG: ${{ steps.date.outputs.tag }}
        run: |
          rm -f planet-*.coastline.gpkg planet-*.coastline.gpkg.{sha256,metadata}
          rm -f planet-*.coastline.gpkg-journal
          rm -f planet-*.coastline.geojson planet-*.coastline.geojson.{sha256,metadata}
          rm -f planet-*.coastline.parquet planet-*.coastline.parquet.{sha256,metadata}
          rm -f planet-*.coastline.osmcoastline.log
          rm -f planet-latest.osm.pbf.*.partial
          find /tmp -name "tmp.*" -user "$USER" -delete 2>/dev/null || true
          # Clean up osmcoastline build directory if it exists
          rm -rf /tmp/osmcoastline
          # Remove old PBF files, keep today's for caching
          for f in planet-*.osm.pbf; do
            [ -f "$f" ] && [ "$f" != "planet-${TAG}.osm.pbf" ] && rm -f "$f" || true
          done
